<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hlášení šikany – anonymní chat</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f5f7fb;color:#1a1f36}
    header{padding:16px 20px;background:#fff;border-bottom:1px solid #e6e8f0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0}
    .app{max-width:900px;margin:0 auto;padding:20px}
    .card{background:#fff;border:1px solid #e6e8f0;border-radius:12px;padding:16px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{background:#4A90E2;color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#e9eef9;color:#1a1f36}
    .btn.danger{background:#e74c3c}
    .hidden{display:none}
    input,select,textarea{width:100%;padding:10px;border:1px solid #d7ddea;border-radius:10px}
    .chat{height:380px;overflow:auto;border:1px solid #e6e8f0;border-radius:12px;padding:12px;background:#fafbff}
    .msg{margin:8px 0;max-width:76%}
    .msg.me{margin-left:auto;text-align:right}
    .bubble{display:inline-block;padding:10px 12px;border-radius:12px;background:#e9eef9}
    .me .bubble{background:#4A90E2;color:white}
    .meta{font-size:12px;color:#65708a;margin-top:4px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef3ff;font-size:12px;margin-left:8px}
    .muted{color:#65708a}
    .list{max-height:380px;overflow:auto}
    .hr{height:1px;background:#e6e8f0;margin:12px 0}
    .danger-note{background:#fff3f2;border:1px solid #ffd6d1;color:#8a1f16;border-radius:10px;padding:10px;margin-top:8px;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #e6e8f0;text-align:left}
  </style>
</head>
<body>
<header>
  <div><strong>Hlášení šikany</strong> <span class="pill">MVP</span></div>
  <div id="userInfo" class="muted">Nepřihlášen</div>
</header>

<div class="app">

  <!-- Start karta -->
  <div id="screen-start" class="card">
    <h2>Bezpečný anonymní chat</h2>
    <p>Tady si můžeš v klidu a anonymně napsat se školním psychologem. Nezadáváš jméno ani e-mail.</p>
    <div class="danger-note">
      <strong>Důležité:</strong> Není to služba 24/7. V naléhavých případech volej <strong>155</strong> nebo linku důvěry <strong>116 111</strong>.
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn" id="btnStartAnon">Začít anonymně</button>
      <button class="btn secondary" id="btnStaffGoogle">Jsem personál (Google přihlášení)</button>
    </div>
  </div>

  <!-- Výběr příjemce (žák) -->
  <div id="screen-target" class="card hidden">
    <h3>Komu chceš napsat?</h3>
    <select id="targetSelect">
      <option value="psycholog">Školní psycholog</option>
    </select>
    <div class="row" style="margin-top:12px">
      <button class="btn" id="btnStartThread">Začít chat</button>
    </div>
  </div>

  <!-- Chat pro žáka -->
  <div id="screen-chat" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h3>Chat s <span id="chatTarget">psychologem</span></h3>
      <div>
        <button class="btn secondary" id="btnCopyLink">Uložit tajný odkaz</button>
        <button class="btn danger" id="btnPanic">Rychle zavřít</button>
      </div>
    </div>
    <div class="chat" id="chatBox"></div>
    <div class="row">
      <input id="msgInput" placeholder="Napiš zprávu…" />
      <button class="btn" id="btnSend">Odeslat</button>
    </div>
    <div class="muted" style="margin-top:6px" id="threadInfo"></div>
  </div>

  <!-- Admin (personál) -->
  <div id="screen-admin" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h3>Admin – vlákna</h3>
      <div class="row">
        <button class="btn secondary" id="btnSignOut">Odhlásit</button>
      </div>
    </div>
    <div class="list" id="threadList"></div>
    <div class="hr"></div>
    <div id="adminThread" class="hidden">
      <h4>Vlákno: <span id="adminThreadLabel"></span></h4>
      <div class="chat" id="adminChatBox"></div>
      <div class="row">
        <input id="adminMsgInput" placeholder="Odpovědět…" />
        <button class="btn" id="btnAdminSend">Odeslat</button>
      </div>
    </div>
    <!-- jen ředitel -->
    <div id="screen-users" class="hidden">
      <h4>Uživatelé a role</h4>
      <table id="usersTable"><thead><tr><th>Email</th><th>Role</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDCPcu7-rkjkT9wHUPSyfQ3nU3iSL3-kXE",
  authDomain: "hlaseni-sikany.firebaseapp.com",
  projectId: "hlaseni-sikany",
  storageBucket: "hlaseni-sikany.appspot.com",
  messagingSenderId: "81853324489",
  appId: "1:81853324489:web:28b8ce2d87c2e90490118"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const $ = id=>document.getElementById(id);
const show = id=>$(id).classList.remove('hidden');
const hide = id=>$(id).classList.add('hidden');

let currentUser=null, currentRole=null, currentThreadId=null, unsubChat=null, unsubAdminChat=null, adminSelectedThread=null;

// Přihlášení žák
$('btnStartAnon').onclick = async ()=>{
  await auth.signInAnonymously();
  hide('screen-start'); show('screen-target');
};

// Přihlášení personál
$('btnStaffGoogle').onclick = async ()=>{
  try{
    const provider=new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  }catch(e){ alert("Google přihlášení selhalo: "+e.message); }
};

$('btnSignOut').onclick = async ()=>{ await auth.signOut(); location.reload(); };

// Vytvoření vlákna
$('btnStartThread').onclick = async ()=>{
  const nick="Žák-"+Math.random().toString(16).slice(2,6).toUpperCase();
  const target=$('targetSelect').value;
  const ref=await db.collection('threads').add({
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),
    targetRole:target,status:'open',
    studentUid:currentUser.uid,studentNick:nick
  });
  currentThreadId=ref.id;
  $('chatTarget').innerText=target;
  hide('screen-target'); show('screen-chat');
  startStudentChatListen();
  $('threadInfo').innerText=`Tvoje přezdívka: ${nick} · Vlákno: ${currentThreadId}`;
};

// Posílání zpráv (žák)
$('btnSend').onclick=async()=>{
  const txt=$('msgInput').value.trim();
  if(!txt||!currentThreadId) return;
  $('msgInput').value='';
  await db.collection('threads').doc(currentThreadId).collection('messages').add({
    author:'student',text:txt,createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
};

// Panic tlačítko
$('btnPanic').onclick=()=>{ location.replace('https://www.google.com'); };

// Kopírování odkazu
$('btnCopyLink').onclick=()=>{
  const link=location.origin+location.pathname+'?t='+currentThreadId;
  navigator.clipboard.writeText(link).then(()=>alert("Tajný odkaz uložen"));
};

// Admin posílání zpráv
$('btnAdminSend').onclick=async()=>{
  const txt=$('adminMsgInput').value.trim();
  if(!txt||!adminSelectedThread) return;
  $('adminMsgInput').value='';
  await db.collection('threads').doc(adminSelectedThread.id).collection('messages').add({
    author:'staff',text:txt,createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
};

function renderMsg(container,doc,asMe){
  const d=doc.data();
  const div=document.createElement('div');
  div.className='msg'+(asMe?' me':'');
  div.innerHTML=`<div class="bubble">${d.text||''}</div><div class="meta">${d.author==='student'?'Žák':'Personál'} • ${(d.createdAt?.toDate?.()||new Date()).toLocaleString()}</div>`;
  container.appendChild(div); container.scrollTop=container.scrollHeight;
}

function startStudentChatListen(){
  if(unsubChat){unsubChat();unsubChat=null;}
  const box=$('chatBox'); box.innerHTML='';
  unsubChat=db.collection('threads').doc(currentThreadId).collection('messages').orderBy('createdAt','asc').onSnapshot(snap=>{
    box.innerHTML='';
    snap.forEach(doc=>{renderMsg(box,doc,doc.data().author==='student');});
  });
}

function startAdminChatListen(id){
  if(unsubAdminChat){unsubAdminChat();unsubAdminChat=null;}
  const box=$('adminChatBox'); box.innerHTML='';
  unsubAdminChat=db.collection('threads').doc(id).collection('messages').orderBy('createdAt','asc').onSnapshot(snap=>{
    box.innerHTML='';
    snap.forEach(doc=>{renderMsg(box,doc,doc.data().author==='staff');});
  });
}

function openAdmin(){
  hide('screen-start'); show('screen-admin');
  const list=$('threadList');
  db.collection('threads').orderBy('createdAt','desc').onSnapshot(snap=>{
    list.innerHTML='';
    snap.forEach(doc=>{
      const d=doc.data();
      const item=document.createElement('div');
      item.className='card';
      item.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
        <div><div><strong>${d.studentNick||'Žák'}</strong> <span class="pill">${d.targetRole}</span></div><div class="muted">${doc.id}</div></div>
        <div class="row">${currentRole!=='ucitel'?`<button class="btn secondary" data-open="${doc.id}">Otevřít</button>`:''}</div>
      </div>`;
      list.appendChild(item);
    });
    list.querySelectorAll('button[data-open]').forEach(btn=>{
      btn.onclick=async()=>{
        const id=btn.getAttribute('data-open');
        adminSelectedThread={id};
        $('adminThreadLabel').innerText=id;
        show('adminThread'); startAdminChatListen(id);
      };
    });
  });

  // pokud je ředitel → načti uživatele
  if(currentRole==='reditel'){
    show('screen-users');
    db.collection('users').onSnapshot(snap=>{
      const tbody=$('usersTable').querySelector('tbody'); tbody.innerHTML='';
      snap.forEach(doc=>{
        const d=doc.data();
        tbody.innerHTML+=`<tr><td>${d.email}</td><td>${d.role}</td></tr>`;
      });
    });
  }
}

// Sleduj změnu auth stavu
auth.onAuthStateChanged(async u=>{
  currentUser=u; if(!u){$('userInfo').innerText='Nepřihlášen'; return;}
  if(u.isAnonymous){$('userInfo').innerText='Anonymní uživatel'; return;}
  $('userInfo').innerText=`${u.email}`;
  // načti roli z Firestore
  const ref=await db.collection('users').doc(u.uid).get();
  currentRole=ref.exists?ref.data().role:null;
  if(!currentRole){ alert("Tvůj účet nemá přidělenou roli."); await auth.signOut(); return;}
  openAdmin();
});
</script>
</body>
</html>
